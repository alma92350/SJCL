<!doctype html>
<head>
  <title>My SJCL Wrapper v2</title>
  <script type="text/javascript" src="sjcl.js"></script>
</head>
<body onload="mySJCL();">
    	<p id="top"></p>
	<br>
    
<script>

/* Encrypt a message */
function doEncrypt(password,plaintext) {
  var rp = {}, ct, p;
  
  p = { //adata:"",
        //iter:10000,
        //mode:"ccm",
        ts:64,
        ks:256
        };

  ct = sjcl.encrypt(password, plaintext, p, rp);
  return ct;
}

/* Decrypt a message */
function doDecrypt(password, ciphertext) {
  var aes, rp = {}, outstring="";

  if (ciphertext.match("{")) {
    /* it's jsonized */
    try {
      outstring = sjcl.decrypt(password, ciphertext, {}, rp);
    } catch(e) {
      outstring= "Can't decrypt: " + e ;
      return outstring;
    }
    return (outstring);
	  
  } else {
	    outstring = "It's not jsonized";
	    return outstring;
    }
}

	
    /////////////////
    //// Receiver
    ////////////////
    function myUriEncode(str){
        str = str.replace('%', "%25");
	    return str.replace('&', "%26");
    }
    
    function myUriDecode(str){
        str = str.replace('%26', "&");
	    return str.replace('%25', "%");
    }
	
function clear(){
	document.getElementById("top").innerHTML = "";
}
	
function doEncrypt2(){
	var appInventorInputs = window.AppInventor.getWebViewString();
	var parameter, ct;
	try {
		parameter = JSON.parse(appInventorInputs);
		ct = doEncrypt(parameter.psw,parameter.data);
		window.AppInventor.setWebViewString(ct);
	} catch(e) {
		var resp =  "Error parsing the WebView string" + e;
		window.AppInventor.setWebViewString(resp);
	}
}
	
function doDecrypt2(){
	var appInventorInputs = window.AppInventor.getWebViewString();
	var parameter, outstring;
	try {
		parameter = JSON.parse(appInventorInputs);
		outstring = doDecrypt(parameter.psw,parameter.data);
		window.AppInventor.setWebViewString(outstring);
	} catch(e) {
		var resp = "Error: " + e;
		window.AppInventor.setWebViewString(resp);
	}
}

function debug(){
	var appInventorInputs = window.AppInventor.getWebViewString();
	var parameter, outstring;
	try {
		parameter = JSON.parse(appInventorInputs);
		outstring = "Debug result: got the input: " + parameter.input;
		window.AppInventor.setWebViewString(outstring);
	} catch(e) {
		var resp = "Error: " + e;
		window.AppInventor.setWebViewString(resp);
	}
	
}
	
function mySJCL() {
	window.AppInventor.setWebViewString("ready");
}
	
function doEncrypt3(){
	var appInventorInputs = window.AppInventor.getWebViewString();
	var parameter, ct, resp;
	try {
		parameter = JSON.parse(appInventorInputs);
		//ct = JSON.parse(doEncrypt(parameter.psw,parameter.data));
		ct = doEncrypt(parameter.psw,parameter.data);
		
		resp = {
			status: "ok",
			command: "encrypt",
			result: ct,
		};
		window.AppInventor.setWebViewString(JSON.stringify(resp));
	} catch(e) {
		var err = "Error parsing the WebView string: " + e;
		resp = {
			status: "nok",
			command: "encrypt",
			result: err,
		};			
		window.AppInventor.setWebViewString(JSON.stringify(resp));
	}
}

function doDecrypt3(){
	var appInventorInputs = window.AppInventor.getWebViewString();
	var parameter, outstring="", resp, rp={};
	
	/// try parse the input string
	try {
		parameter = JSON.parse(appInventorInputs);
	} catch(e) {
		resp = {
			"status": "nok",
			"command": "decrypt",
			"result": "unable to parse WebViewString",
		};
		window.AppInventor.setWebViewString(JSON.stringify(resp));
		return;
	}
	/// Check if input is json string
	if (parameter.data.match("{")) {
		// try to decrypt
		try {
			outstring = sjcl.decrypt(parameter.psw,parameter.data, {}, rp);
			resp = {
				"status": "ok",
				"command": "decrypt",
				"result": outstring,
			};
			window.AppInventor.setWebViewString(JSON.stringify(resp));
			return;
		} catch (e) {
			outstring= "Can't decrypt: " + e ;
			resp = {
				"result": outstring,
				"command": "decrypt",
				"status": "nok"
			};
			window.AppInventor.setWebViewString(JSON.stringify(resp));
			return;
		}
	} else { 
		// it is not a json string
		resp = {
			"result": "data is not a json string",
			"command": "decrypt",
			"status": "nok"
		};
		window.AppInventor.setWebViewString(JSON.stringify(resp));
		return;
	}
}
	
</script>
    
</body>
</html>
